<!DOCTYPE html>
<html ng-app="ReportPreviewPage" id="ng-app">
<head>
    <meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

    <title>Report Preview</title>
    <link href="../libs/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
	<!--[if IE]><script type="text/javascript" src="../libs/excanvas.js"></script><![endif]-->
      <!--[if lte IE 8]>
        <script>
          document.createElement('ng-include');
          document.createElement('ng-pluralize');
          document.createElement('ng-view');

          // Optionally these for CSS
          document.createElement('ng:include');
          document.createElement('ng:pluralize');
          document.createElement('ng:view');
        </script>
      <![endif]-->
    <style type="text/css">
        .well {            
            background-color: #ffffff;
        }
        .box-row1 {
            padding-bottom: 0px;
            padding-left: 20px;
            padding-right: 20px;
            padding-top: 20px;
        }
        .box-row2 {
            padding: 20px;
        }
        .btn-primary {
            width:225px;
        }
        .popover {
        	min-width: 200px;
        	text-align: center;
        }
        .popoverButton {
           	margin-right: 10px;
        }
        .popoverButton:hover {
        	cursor: pointer;
        	cursor: hand;
        }
		.table tr {
          border: none !important;
		  vertical-align: middle !important;
		}
		.table th {
			font-weight: normal;
			font-size: 18px;
		}
		.table td {
          border: none !important;
		  vertical-align: middle !important;
		}
		.table-hover {
		  background: #FFF;
		  color: #0D0A52;
		  margin-top: 20px;
		  border-radius: 8px !important; 
		  border-collapse: collapse !important;
		}
		.table-hover tr > th {
		  border-radius: 10px 10px 0 0!important;
		}
		.table-hover tbody tr:hover td, .table-hover tbody tr:hover th {
		  background-color: #F3F6FC;
		}
		.table-hover tbody tr:last-child:hover td:first-child {
		  border-radius: 0 0 0 8px;
		}
		.table-hover tbody tr:last-child:hover td:last-child {
		  border-radius: 0 0 8px 0;
		}
		#restoreDefaultParametersButton {
			margin-right: 25px;
		}
		.result-charts-variant-container {
			width: 450px;
			margin-bottom: 25px;
		}
		.result-charts-variant-container .variant-label {
			width: 80%;
			text-align: center;
		}
		.legend-container {
			float: left;
			width: 150px;
			margin-right: 25px;
		}
		.legend .title {
			display: block;
			margin-bottom: 5px;
			border-radius: 5px;
		}
		.legend .glyphicon {
			margin-right: 10px;
		}
		#result-total-container {
			margin-bottom: 25px;		
		}
		#indicatorSelection {
			max-width: 400px;
			margin-bottom: 25px;
		}
    </style>
</head>

<body>
	<div id="contentDiv" data-ng-controller="Controller">
		<div class="container-fluid" style="margin:20px">
			<div class="row">
				<h1 class="col-sm-12 box-row1">{{report.title}}</h1>
			</div>
			<div class="row">
				<div data-ng-repeat="section in report.sections" class="col-sm-12 box-row1">
					<h3>{{section.title}}</h3>
					<p data-ng-bind-html="section.text"></p>
                    <div data-ng-if="section.componentId == 'variant_table'" data-ng-include src="'variants-table.html'"></div>
                    <div data-ng-if="section.componentId == 'indicator_table'" data-ng-include src="'indicator_table.html'"></div>
                    <div data-ng-if="section.componentId == 'parameter_table'" data-ng-include src="'parameters-table.html'"></div>
					<div id="result-charts-include-container" data-ng-if="section.componentId == 'total_result_chart'" data-ng-include src="'total-result-charts.html'"></div>
					<div data-ng-if="section.componentId == 'variants_result_charts'" data-ng-include src="'variants-result-charts.html'"></div>
					<div data-ng-if="section.componentId == 'result_table'" data-ng-include src="'result-table.html'"></div>
				</div>
			</div>
		</div>
	</div>

    <script src="../libs/jquery.min_1.9.0.js"></script>
    <script src="../libs/angular.min.js"></script>
	<script src="../libs/angular-sanitize.min.js"></script>
    <script src="../libs/angularui.min.js"></script>
    <script src="../libs/ChartHorizontalBar.js"></script>
    <script src="../libs/olca.utils.js"></script>
    <script src="../libs/ui-bootstrap-tpls-0.11.0.min.js"></script>

	<script type="text/ng-template" id="parameters-table.html">
		<div class="table-responsive">
			<table class="table table-hover">
				<thead><tr><th>Parameter</th><th>Description</th><th>Value</th></tr></thead>
				<tbody>
				<tr data-ng-repeat="parameter in report.parameters">
					<td>
						{{parameter.userFriendlyName}}
					</td>
					<td>
						{{parameter.description}}
					</td>
					<td><input type="number" class="form-control" placeholder="Enter value" data-ng-model="parameter.value"></td>
				</tr>
                </tbody>
			</table>
		</div>
		<button class="pull-right btn btn-primary" onclick="calculate()">Calculate</button>
		<button id="restoreDefaultParametersButton" class="pull-right btn btn-primary" data-ng-click="restoreReportParameters(report)">Restore Defaults</button>
	</script>

	<script type="text/ng-template" id="variants-table.html">
		<div class="table-responsive">
			<table class="table table-hover">
				<thead><tr><th>Variant</th><th>Description</th></tr></thead>
				<tbody>
				<tr data-ng-repeat="variant in report.variants">
					<td>
						{{variant.userFriendlyName}}
					</td>
					<td>
						{{variant.description}}
					</td>
				</tr>
                </tbody>
			</table>
		</div>
	</script>

    <!-- indicator table template -->
    <script type="text/ng-template" id="indicator_table.html">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>LCIA category</th>
                        <th>Unit</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-ng-repeat="indicator in report.indicators | filter: {displayed:true}">
                        <td>
                            {{indicator.reportName}}
                        </td>
                        <td>
                            {{indicator.descriptor.referenceUnit}}
                        </td>
                        <td>
                            {{indicator.reportDescription}}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </script>

    <!-- result table template -->
	<script type="text/ng-template" id="result-table.html">
		<div class="table-responsive">
			<table class="table table-hover">
				<thead>
					<tr>
						<th>LCIA category</th>
						<th data-ng-repeat="result in report.results[0].variantResults">{{result.variant}}</th>
						<th>Unit</th>
					</tr>
				</thead>
				<tbody>
				<tr data-ng-repeat="result in report.results">
					<td>
						{{getIndicatorName(result.indicatorId)}}
					</td>
					<!-- TODO: this assumes that the order of the variants is the same for every result -->
					<td data-ng-repeat="variantResult in result.variantResults">
						{{variantResult.totalAmount | scientific}}
					</td>
					<td>
						{{getIndicatorUnit(result.indicatorId)}}
					</td>
				</tr>
                </tbody>
			</table>
		</div>
	</script>

	<script type="text/ng-template" id="total-result-charts.html">
        <div id="result-total-container" class="col-xs-12">
            <div total-chart="exp" result="totalResult">
                <div id="result-total-legend-container" class="legend-container"></div>
                <div id="result-total-canvas"></div>
            </div>
        </div>
	</script>

	<script type="text/ng-template" id="variants-result-charts.html">
        <select id="indicatorSelection" class="form-control" data-ng-options="result as getIndicatorName(result.indicatorId) for result in report.results" data-ng-model="selectedIndicator"></select>
        <div data-ng-repeat="variantResult in selectedIndicator.variantResults" class="result-charts-container col-xs-12 col-sm-6 col-md-6 col-lg-4">
            <div variants-charts="exp" variant="variantResult">
                <div class="result-charts-variant-container">
                    <div class="variant-label alert alert-info">{{variantResult.variant}}</div>
                        <div class="legend-container"></div>
                    <div class="result-canvas-container"></div>
                </div>
            </div>
        </div>
	</script>

    <script type="text/javascript">
        var variantsIndex = 0;
        var app = angular.module('ReportPreviewPage', ['ui.bootstrap', 'ngSanitize']);

        app.filter('scientific', function () {
            return function (text) {
                return parseFloat(text).toExponential(5);
            };
        });

	    var Controller = function ($scope) {
        	$scope.report = {};           

            $scope.restoreReportParameters = function (report) {
            	angular.forEach(report.parameters, function(parameter, key){
            		angular.forEach(parameter, function(value, key){
            			if (key == 'value')
            				parameter.value = parameter.defaultValue;
            		    });
           	     });      	
            };

            $scope.getIndicatorName = function(indicatorId) {
                var indicators = $scope.report.indicators;
                for(var i = 0; i < indicators.length; i++) {
                    var indicator = indicators[i];
                    if(indicator.id === indicatorId) {
                        return indicator.reportName;
                    }
                }
                return "";
            };

            $scope.getIndicatorUnit = function(indicatorId) {
                var indicators = $scope.report.indicators;
                for(var i = 0; i < indicators.length; i++) {
                    var indicator = indicators[i];
                    if(indicator.id === indicatorId) {
                        return indicator.descriptor.referenceUnit;
                    }
                }
                return "";
            };


		};

        app.controller('Controller', Controller);

	    app.directive('popover', function() {
	        var fn;
	        fn = function(scope, element, attrs) {
	    	    	$(document).ready(function () {
	    	    	    /* $(".popoverButton").popover({
	    	    	        placement : 'right'
	    	    	    }); */
	    	    	});
	         	};
	        return {
	            restrict: 'E',
	            link: { post : fn }
	        };
	    });

	    app.directive("totalChart", function () {
	        var fn;
	        fn = function(scope, element, attrs) {
	    	    	$(document).ready(function () {
                        scope.$watch('result', function() {
                            if(typeof scope.result !== 'undefined'){
                                var containerId = 'result-total-canvas-container';
                                var canvasElement = document.createElement('canvas');
                                canvasElement.setAttribute("width", 800);
                                canvasElement.setAttribute("border", "1px solid white");
                                canvasElement.setAttribute("height", 1600);
                                canvasElement.setAttribute("class", "mapping");
                                var canvasContainer = element.first().find('#result-total-canvas');
                                canvasContainer.attr('id', containerId);
                                document.getElementById(containerId).appendChild(canvasElement);
                                if (isIE(8,'lte')) {
                                    canvasElement = G_vmlCanvasManager.initElement(canvasElement);
                                }
                                var ctxTotalBarChart = canvasElement.getContext("2d");
                                var totalBarChart = new Chart(ctxTotalBarChart);
                                var dataTotalBarChart = scope.result;
                                new Chart(ctxTotalBarChart).HorizontalBar(dataTotalBarChart, {
                                    scaleOverride: true,
                                    scaleSteps: 10,
                                    scaleStepWidth: 10,
                                    scaleStartValue: 0,
                                    barDatasetSpacing : 0.5,
                                    barValueSpacing : 5,
                                    animationEasing : "easeOutQuart",
                                    animationSteps : 50
                                });
                                var resultLegend = document.createElement('div');
                                var resultLegendId = 'result-total-legend';
                                resultLegend.id = resultLegendId;
                                document.getElementById('result-total-legend-container').appendChild(resultLegend);
                                legend(document.getElementById(resultLegendId), dataTotalBarChart, 'variant');
                            };
                        });
	    	    	});
	         	};
	    	  return {
	    		    restrict: "EA",
	    		    scope: { result: "=result" },
	    			link: fn
    		  }
   		});

	    app.directive("variantsCharts", function () {
	        var fn;
	        fn = function(scope, element, attrs) {
	    	    	$(document).ready(function () {
						var containerId = 'variant-chart-container-' + variantsIndex.toString();
						var canvasElement = document.createElement('canvas');
						canvasElement.setAttribute("width", 200);
						canvasElement.setAttribute("border", "1px solid white");
						canvasElement.setAttribute("height", 200);
						canvasElement.setAttribute("class", "mapping");
						var canvasContainer = element.first().find('.result-canvas-container');
						canvasContainer.attr('id', containerId);
						document.getElementById(containerId).appendChild(canvasElement);
						if (isIE(8,'lte')) {
							canvasElement = G_vmlCanvasManager.initElement(canvasElement);
						}
						var ctxVariantsPieChart = canvasElement.getContext("2d");
						var variantsPieChart = new Chart(ctxVariantsPieChart);
						var dataVariantsPieChart = scope.variant.contributions;
						new Chart(ctxVariantsPieChart).Pie(dataVariantsPieChart, {
							animateRotate : true,
							animateScale: true,
							animationEasing : "easeOutQuart",
							animationSteps : 50
  	    	    	    });
   	    	    	    var legendContainer = element.first().find('.legend-container');
						var legendContainerId = 'legend-container-' + variantsIndex.toString();
						legendContainer.attr('id', legendContainerId);
						var resultLegend = document.createElement('div');
						var resultLegendId = 'result-legend-' + variantsIndex.toString();
						resultLegend.id = resultLegendId;
						document.getElementById(legendContainerId).appendChild(resultLegend);
   	    	    	    legend(document.getElementById(resultLegendId), dataVariantsPieChart, 'process');
                        variantsIndex++;
	    	    	});
	         	};
	    	  return {
	    		    restrict: "EA",
	    		    scope: { variant: "=variant" },
	    			link: fn
    		  }
   		});

        
       function setData(report) {
            var element = document.getElementById("contentDiv");
            var scope = angular.element(element).scope();
            scope.$apply(function () {
                scope.report = report;
                applyResultChartAttributes(scope.report.results);
                calculateRelativeResult(scope.report.results);
                scope.report.results = prepareVariantsData(scope.report.results);
                scope.totalResult = {};
                scope.totalResult = getTotalResult(scope.report.results);
            	scope.selectedIndicator = scope.report.results[0];
            });
        }

        function prepareVariantsData(results) {
			var colors = [ "#E53039", "#296FC4", "#FFC923", "#52A84D", "#844CAD", "#7FB7E5", "#FF8900", "#359B58", "#319444", "#FCFF64" ];
        	angular.forEach(results, function(indicator, key) {
                angular.forEach(indicator.variantResults, function(variantResult, key) {
					var index = 0;
                        angular.forEach(variantResult.contributions, function(contribution, key) {
                            contribution.label = contribution.process;
                            contribution.value = contribution.amount;
                            if (!contribution.isRest)
                                contribution.color = colors[index];
                            else
                                contribution.color = "#AAA";
                            index++;
                       });
                });
            });
            return results;
        }
        
		function calculateRelativeResult(indicators) {
        	angular.forEach(indicators, function(indicator, key){
				var maximum = 0;
            		angular.forEach(indicator.variantResults, function(variant, key){
						if (variant.totalAmount > maximum)
							maximum = variant.totalAmount;
        		    });
					indicator.maximum = maximum;
       	     });
		}
		
        function getTotalResult(indicators) {
        	var totalResult = {};
        	totalResult.labels = [];
        	totalResult.datasets = [];
        	angular.forEach(indicators[0].variantResults, function(variant, key){
				totalResult.datasets.push({});
			});
            
        	angular.forEach(indicators, function(indicator, key){
        			totalResult.labels.push(indicator.indicator);
					var index = 0;
            		angular.forEach(indicator.variantResults, function(variant, key){
						if (!totalResult.datasets[index].data)
							totalResult.datasets[index].data = [];
						if (!totalResult.datasets[index].values)
							totalResult.datasets[index].values = [];
            			totalResult.datasets[index].values.push(variant.totalAmount);
						var relativeValue = variant.totalAmount / (indicator.maximum / 100);
            			totalResult.datasets[index].data.push(relativeValue);
            			totalResult.datasets[index].title = variant.variant;
						totalResult.datasets[index].fillColor = variant.color;
						totalResult.datasets[index].strokeColor = variant.color;	
        				index++;
        		    });
       	     });
        	return totalResult;
        }

		function applyResultChartAttributes(indicators) {
			var colors = [ "#E53039", "#296FC4", "#FFC923", "#52A84D", "#844CAD", "#7FB7E5", "#FF8900", "#359B58", "#319444", "#FCFF64" ];
			angular.forEach(indicators, function(indicator, key) {
                var colorIndex = 0;
				angular.forEach(indicator.variantResults, function(variant, key) {
					var index = 0;
                    var rgb = hexToRgb(colors[colorIndex]);
                    var color = 'rgba(' + rgb.r.toString() + ',' + rgb.g.toString() + ',' + rgb.b.toString() + ',' + '0.5)';
                    variant.color = color.toString();
					angular.forEach(variant.contrbutions, function(item, key){
						if (!item.isRest)
							item.color = colors[index];
						else
							item.color = "#AAA";
						index++;
					});
                    colorIndex++;
				});				
			});      	
		}

		function legend(parent, data, type) {
            parent.className = 'legend';
            var datas = data.hasOwnProperty('datasets') ? data.datasets : data;
            while(parent.hasChildNodes()) {
                parent.removeChild(parent.lastChild);
            }

			var color = '';
			angular.forEach(datas, function(process, key){
				angular.forEach(process, function(value, key){
					if (type == 'process') {
							if (key == 'color') {
								color = value;
							}
					} else if (type == 'variant') {
						color = process.fillColor;
					}
				});
				angular.forEach(process, function(value, key){
					if (key == 'process') {
						var bullet = document.createElement('span');
						bullet.className = 'glyphicon glyphicon-minus'; 
						bullet.style.color = color;
						var title = document.createElement('div');
						title.className = 'title';
						var text = document.createTextNode(value);
						title.appendChild(bullet);
						title.appendChild(text);
						parent.appendChild(title);
					}
				});
			});
        }

		function hexToRgb(hex) {
			var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
			return result ? {
				r: parseInt(result[1], 16),
				g: parseInt(result[2], 16),
				b: parseInt(result[3], 16)
			} : null;
		}

		function isIE(version, comparison) {
			var cc = 'IE',
			b = document.createElement('B'),
			docElem = document.documentElement,
			isIE;
			if(version){
				cc += ' ' + version;
					if(comparison){
						cc = comparison + ' ' + cc;
					}
			}
			b.innerHTML = '<!--[if '+ cc +']><b id="iecctest"></b><![endif]-->';
			docElem.appendChild(b);
			isIE = !!document.getElementById('iecctest');
			docElem.removeChild(b);
			return isIE;
		}

		//do not remove or modify the comment below, it is used as template for static report exports.
		//{{set_data_call}}
		
    </script>
</body>
</html>