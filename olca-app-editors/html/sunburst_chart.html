<!DOCTYPE html>
<html>
<meta charset="utf-8">
<link href="../../libs/bootstrap_2.2.2/css/bootstrap.min.css" rel="stylesheet"
	media="screen">

<body>

	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span12"></div>
			<div class="span12">
				<p id="contributionText" class="lead">Select a segment to see the contributions</p>
			</div>
		</div>
		<div id="chartDiv" class="span12"></div>
	</div>


	<script src="../../libs/d3.v3.min.js"></script>
	<script>
		function setData(data) {
			d3.select("#contributionText").text("Select a segment to see the contributions");
			renderChart(data.root);
		}

		function renderChart(treeRoot) {

			// remove old content
			d3.select("#chartDiv").select("svg").remove();

			var width = 800;
			var height = 600;
			var radius = Math.min(width, height) / 2;
			var color = d3.scale.category20c();

			var svg = d3
					.select("#chartDiv")
					.append("svg")
					.attr("width", width)
					.attr("height", height)
					.append("g")
					.attr("transform",
							"translate(" + width / 2 + "," + height * .52 + ")");

			var partition = d3.layout.partition().sort(null).size(
					[ 2 * Math.PI, radius * radius ]).value(function(d) {
				return d.amount;
			});

			var arc = d3.svg.arc().startAngle(function(d) {
				return d.x;
			}).endAngle(function(d) {
				return d.x + d.dx;
			}).innerRadius(function(d) {
				return Math.sqrt(d.y);
			}).outerRadius(function(d) {
				return Math.sqrt(d.y + d.dy);
			});

			var path = svg.datum(treeRoot).selectAll("path").data(
					partition.nodes).enter().append("path").attr("display",
					function(d) {
						return d.depth ? null : "none";
					}).attr("d", arc).style("stroke", "#fff").style("fill",
					function(d) {
						return color(d.process.id);
					}).style("fill-rule", "evenodd").on("mouseover", mouseover)
					.on("mouseout", mouseout).on("mousedown", mousedown).each(
							stash);

			// Stash the old values for transition.
			function stash(d) {
				d.x0 = d.x;
				d.dx0 = d.dx;
			}

			// Interpolate the arcs in data space.
			function arcTween(a) {
				var i = d3.interpolate({
					x : a.x0,
					dx : a.dx0
				}, a);
				return function(t) {
					var b = i(t);
					a.x0 = b.x;
					a.dx0 = b.dx;
					return arc(b);
				};
			}

			var selection = null;

			function mousedown(d, i) {
				if (selection) {
					applyDefaultStyle(selection.datum, selection.segment);
					selection = null;
				} else {
					var segment = findSegment(i);
					selection = {
						datum : d,
						segment : segment
					};
					applySelection(d, segment);
				}
			}

			function mouseover(d, i) {
				if (selection)
					return;
				var segment = findSegment(i);
				applySelection(d, segment);
			}

			function mouseout(d, i) {
				if (selection)
					return;
				var segment = findSegment(i);
				applyDefaultStyle(d, segment);
			}

			function applySelection(d, segment) {
				var color = "#ff6801";
				d3.select(segment).style("stroke", color).style("fill", color);
				d3.select("#contributionText").text(d.process.name + ": " + d.amount);
			}

			function findSegment(index) {
				var paths = d3.selectAll("path")[0];
				return paths[index];
			}

			function applyDefaultStyle(d, segment) {
				var fill = color(d.process.id);
				d3.select(segment).style("stroke", "#fff").style("fill", fill)
						.style("fill-rule", "evenodd");
			}
		}
	</script>
</body>
</html>